// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// --- Models ---

model GolfCourse {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  name      String    @unique
  location  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  users     User[]
  vehicles  Vehicle[]
  jobs      Job[]
  parts     Part[]
  
  inventory Inventory[]
}

model User {
  id                   String   @id @default(auto()) @map("_id") @db.ObjectId
  code                 String   @unique
  username             String?  @unique
  name                 String
  role                 UserRole
  password             String?  // เพิ่ม password field
  managed_golf_courses String[] @db.ObjectId
  permissions          String[] // สิทธิ์การใช้งานเพิ่มเติม
  is_active            Boolean  @default(true) // สถานะการใช้งาน (false = ถูกระงับ)
  disabled_at          DateTime? // วันที่ถูกระงับ
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  lastActive           DateTime? @default(now())
  isOnline             Boolean   @default(false)

  // Relations
  golf_course_id   String     @db.ObjectId
  golfCourse       GolfCourse @relation(fields: [golf_course_id], references: [id])
  golf_course_name String     // Denormalized field for convenience

  createdJobs  Job[]      @relation("CreatedBy")
  assignedJobs Job[]      @relation("AssignedTo")
  approvedJobs Job[]      @relation("ApprovedBy")
  historyLogs  SerialHistoryEntry[] @relation("PerformedByUser")

  // Stock Relations
  stockTransactions StockTransaction[]
  requestedTransfers StockTransfer[] @relation("TransferRequester")
  approvedTransfers  StockTransfer[] @relation("TransferApprover")

  notifications      Notification[]

  @@map("users") // Map to users collection instead of User
}

model Vehicle {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  vehicle_number   String
  serial_number    String        @unique
  brand            String?
  model            String?
  year             Int?
  battery_serial   String?
  status           VehicleStatus @default(active)
  transfer_date    DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  golfCourse       GolfCourse @relation(fields: [golf_course_id], references: [id])
  golf_course_id   String     @db.ObjectId
  golf_course_name String // Denormalized field for convenience

  jobs             Job[]
  historyLogs      SerialHistoryEntry[]
}

model Job {
  id                 String    @id @default(auto()) @map("_id") @db.ObjectId
  type               JobType
  status             JobStatus
  system             String?
  subTasks           String[]
  remarks            String?
  cost               Float?
  notes              String?
  bmCause            BMCause?
  battery_serial     String?
  partsNotes         String?
  mwr_code           String?   // @unique removed to allow nulls in legacy data. App logic will enforce uniqueness.
  prrNumber          String?   // ลบ @unique เนื่องจากมี null values หลายตัว
  parts              JobPart[]
  images             String[]
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Denormalized fields for convenience
  userName           String?
  vehicle_number     String?

  // Relations
  golfCourse         GolfCourse @relation(fields: [golf_course_id], references: [id])
  golf_course_id     String     @db.ObjectId

  vehicle            Vehicle?  @relation(fields: [vehicle_id], references: [id])
  vehicle_id         String?   @db.ObjectId

  author             User      @relation("CreatedBy", fields: [user_id], references: [id])
  user_id            String    @db.ObjectId

  assignee           User?     @relation("AssignedTo", fields: [assigned_to], references: [id])
  assigned_to        String?   @db.ObjectId

  // ข้อมูลการอนุมัติ
  approvedBy         User?     @relation("ApprovedBy", fields: [approved_by_id], references: [id])
  approved_by_id     String?   @db.ObjectId
  approved_by_name   String?   // Denormalized field สำหรับแสดงชื่อผู้อนุมัติ
  approved_at        DateTime? // วันเวลาที่อนุมัติ/ไม่อนุมัติ
  rejection_reason   String?   // เหตุผลถ้าไม่อนุมัติ
  
  historyLogs        SerialHistoryEntry[]
}

model Part {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  name           String   @unique
  part_number    String?
  category       String?
  unit           String
  stock_qty      Int
  min_qty        Int?
  max_qty        Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  golfCourse     GolfCourse? @relation(fields: [golf_course_id], references: [id])
  golf_course_id String?     @db.ObjectId
  
  inventory      Inventory[]
  transactions   StockTransaction[]
  transferItems  StockTransferItem[]
}

model JobPart {
  id             String @id @default(auto()) @map("_id") @db.ObjectId
  part_id        String
  part_name      String
  quantity_used  Int
  
  // Relations
  job            Job    @relation(fields: [jobId], references: [id])
  jobId          String @db.ObjectId
}

model PartsUsageLog {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  jobId            String
  partName         String
  partId           String
  quantityUsed     Int
  vehicleNumber    String
  vehicleSerial    String
  golfCourseName   String
  usedBy           String
  usedDate         String
  notes            String
  jobType          String
  system           String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model SerialHistoryEntry {
  id                   String     @id @default(auto()) @map("_id") @db.ObjectId
  serial_number        String
  vehicle_number       String
  action_type          ActionType
  action_date          DateTime   @default(now())
  actual_transfer_date DateTime?
  details              String
  is_active            Boolean
  status               String?
  job_type             String?
  golf_course_name     String?
  parts_used           String[]   // เพิ่มฟิลด์สำหรับเก็บรายการอะไหล่ที่ใช้
  system               String?    // เพิ่มฟิลด์สำหรับเก็บระบบที่ซ่อม
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  
  // Relations
  vehicle              Vehicle    @relation(fields: [vehicle_id], references: [id])
  vehicle_id           String     @db.ObjectId
  
  performed_by         User?      @relation("PerformedByUser", fields: [performed_by_id], references: [id])
  performed_by_id      String?    @db.ObjectId

  related_job          Job?       @relation(fields: [related_job_id], references: [id])
  related_job_id       String?    @db.ObjectId
}



// --- Enums ---

enum UserRole {
  admin
  supervisor
  staff
  technician
  viewer
  central
  manager
  stock
  clerk
}

enum JobType {
  PM
  BM
  Recondition
  PART_REQUEST // For MWR (Restocking/Transfer Request)
}

enum JobStatus {
  pending
  assigned
  in_progress
  completed
  approved
  rejected
}

enum VehicleStatus {
  active
  ready
  maintenance
  retired
  parked
  spare
  inactive
}

enum BMCause {
  breakdown
  accident
  wear
  other
}

enum ActionType {
  registration
  transfer
  maintenance
  decommission
  inspection
  status_change
  data_edit
  data_delete
  bulk_transfer
  bulk_upload
}

enum TransactionType {
  IN     // Receive / Purchase
  OUT    // Usage / Withdraw
  ADJUST // Correction
  TRANSFER // Move between locations
}

enum StockTransferStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

model Inventory {
  id             String      @id @default(auto()) @map("_id") @db.ObjectId
  part           Part        @relation(fields: [part_id], references: [id])
  part_id        String      @db.ObjectId
  
  golfCourse     GolfCourse? @relation(fields: [golf_course_id], references: [id])
  golf_course_id String?     @db.ObjectId // Null = Central Warehouse
  
  quantity       Int         @default(0)
  min_qty        Int         @default(0)
  max_qty        Int         @default(100) // Reorder point?
  location       String?     // Shelf location, bin number, etc.
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@unique([part_id, golf_course_id])
}

model StockTransaction {
  id               String          @id @default(auto()) @map("_id") @db.ObjectId
  type             TransactionType
  quantity         Int
  previous_balance Int
  new_balance      Int
  
  part             Part            @relation(fields: [part_id], references: [id])
  part_id          String          @db.ObjectId
  
  // Location Context
  location_id      String?         @db.ObjectId // Where the transaction happened
  location_name    String?         // Denormalized name (Central or Site Name)
  
  // For Transfers
  to_location_id   String?         @db.ObjectId
  
  // References
  ref_type         String          // JOB, MWR, TRANSFER, ADJUST, PURCHASE
  ref_id           String?         @db.ObjectId // ID of the Job or Transfer
  ref_document     String?         // Display ID (e.g., MWR-2402-001)
  
  user             User            @relation(fields: [user_id], references: [id])
  user_id          String          @db.ObjectId
  user_name        String?         // Denormalized
  
  notes            String?
  createdAt        DateTime        @default(now())
}

model StockTransfer {
  id               String              @id @default(auto()) @map("_id") @db.ObjectId
  mwr_code         String?             // Linked MWR (if initiated by MWR)
  
  from_course_id   String?             @db.ObjectId // Null = Central
  to_course_id     String              @db.ObjectId // Destination Site
  
  status           StockTransferStatus @default(PENDING)
  
  items            StockTransferItem[]
  
  requested_by     User                @relation("TransferRequester", fields: [requested_by_id], references: [id])
  requested_by_id  String              @db.ObjectId
  
  approved_by      User?               @relation("TransferApprover", fields: [approved_by_id], references: [id])
  approved_by_id   String?             @db.ObjectId
  approved_at      DateTime?
  
  notes            String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
}

model StockTransferItem {
  id             String        @id @default(auto()) @map("_id") @db.ObjectId
  transfer       StockTransfer @relation(fields: [transfer_id], references: [id], onDelete: Cascade)
  transfer_id    String        @db.ObjectId
  
  part           Part          @relation(fields: [part_id], references: [id])
  part_id        String        @db.ObjectId
  
  quantity       Int
}

model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  title     String
  message   String
  type      String   @default("info") // info, warning, success, error
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
}
